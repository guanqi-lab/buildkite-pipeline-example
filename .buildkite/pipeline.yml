#.buildkite/pipeline.yml
# è¯¥æ–‡ä»¶å®šä¹‰äº†åœ¨ Buildkite Agent ä¸Šæ‰§è¡Œçš„å®Œæ•´éƒ¨ç½²æµç¨‹ã€‚

# å®šä¹‰æµæ°´çº¿çº§åˆ«çš„ç¯å¢ƒå˜é‡ï¼Œè¿™äº›å˜é‡å¯¹æ‰€æœ‰æ­¥éª¤éƒ½å¯ç”¨ã€‚
env:
  # æ‚¨çš„ GitHub ç”¨æˆ·åï¼Œç”¨äº Docker ç™»å½•ã€‚
  # å»ºè®®åœ¨æ­¤å¤„è®¾ç½®æˆ–åœ¨é›†ç¾¤/Agentçº§åˆ«è®¾ç½®ã€‚
  GITHUB_USERNAME: "guanqi-lab"
  # æ‚¨çš„ GitHub ä»“åº“åç§°ï¼Œç”¨äºæ„é€ é•œåƒURLã€‚
  GITHUB_REPO_NAME: "buildkite-pipeline-example"

steps:
  # æ­¥éª¤é›¶ï¼šç¯å¢ƒæ£€æµ‹å’Œé…ç½®
  - label: ":gear: Environment Detection"
    key: "env-detect"
    command: |
      echo "--- :mag: æ£€æµ‹éƒ¨ç½²ç¯å¢ƒ"
      echo "åˆ†æ”¯: ${BUILDKITE_BRANCH}"
      echo "ç¯å¢ƒ: ${DEPLOY_ENVIRONMENT}"
      echo "å‰ç¼€: ${ENV_PREFIX}"
      echo "æ ‡è¯†: ${ENV_EMOJI} ${ENV_NAME}"
      
      # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
      buildkite-agent meta-data set "deploy_environment" "${DEPLOY_ENVIRONMENT:-production}"
      buildkite-agent meta-data set "env_prefix" "${ENV_PREFIX:-PROD}"
      buildkite-agent meta-data set "env_emoji" "${ENV_EMOJI:-ğŸš€}"
      buildkite-agent meta-data set "env_name" "${ENV_NAME:-ç”Ÿäº§ç¯å¢ƒ}"
      
      echo "âœ… ç¯å¢ƒä¿¡æ¯å·²ä¿å­˜åˆ° meta-data"

  # ç­‰å¾…ç¯å¢ƒæ£€æµ‹å®Œæˆ
  - wait

  # æ­¥éª¤ä¸€ï¼šè®¤è¯å¹¶æ‹‰å– Docker é•œåƒ
  - label: ":docker: Pull Image"
    key: "pull-image"
    command: "scripts/pull_image.sh"

  # ç­‰å¾…æ­¥éª¤ï¼šç¡®ä¿ä¸Šä¸€æ­¥æˆåŠŸå®Œæˆåå†ç»§ç»­
  - wait

  # æ­¥éª¤äºŒï¼šæ‰§è¡Œéƒ¨ç½²
  - label: ":rocket: Deploy Application"
    key: "deploy-app"
    command: "scripts/deploy.sh"
    # å®šä¹‰ä¾èµ–å…³ç³»ï¼Œç¡®ä¿æ­¤æ­¥éª¤åœ¨ "pull-image" æˆåŠŸåæ‰è¿è¡Œ
    depends_on: "pull-image"

  # ç­‰å¾…éƒ¨ç½²æ­¥éª¤å®Œæˆï¼ˆæ— è®ºæˆåŠŸå¤±è´¥ï¼‰
  - wait: ~
    continue_on_failure: true

  # æ­¥éª¤ä¸‰ï¼šå‘é€é€šçŸ¥ï¼ˆæ— è®ºéƒ¨ç½²æˆåŠŸå¤±è´¥éƒ½ä¼šæ‰§è¡Œï¼‰
  - label: ":lark: Send Notification"
    key: "notify-result"
    command: "scripts/notify_lark.sh"
    depends_on: 
      - "deploy-app"
    # å…è®¸åœ¨å‰é¢æ­¥éª¤å¤±è´¥æ—¶ä»ç„¶æ‰§è¡Œé€šçŸ¥
    soft_fail: true